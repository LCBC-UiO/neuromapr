name: Cross-validate with Python

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'R/nulls-*.R'
      - 'tools/generate-reference-data.py'
      - 'tests/testthat/test-cross-validation.R'

permissions:
  contents: read

jobs:
  cross-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install numpy scipy brainsmash

      - name: Generate reference fixtures
        run: python tools/generate-reference-data.py

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::jsonlite

      - name: Run cross-validation tests
        run: |
          Rscript -e '
            testthat::test_file(
              "tests/testthat/test-cross-validation.R",
              reporter = testthat::CheckReporter$new()
            )
          '
