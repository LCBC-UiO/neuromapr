# neuromapr

Brain maps are spatially autocorrelated — nearby regions have similar
values just because they are neighbours. Standard correlation tests
ignore this and produce inflated p-values. neuromapr generates
spatially-constrained surrogate maps that preserve autocorrelation
structure, so you can test whether the similarity between two brain maps
is more than a spatial artifact.

The package implements the framework described in [Markello et
al. (2022)](https://doi.org/10.1038/s41592-022-01625-w) and provides
eight null model methods, parcellation utilities, geodesic surface
distance, and coordinate-space transforms.

This package was co-developed with [Claude
Code](https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/overview)
(Anthropic’s Claude Opus 4.6). While the test suite is thorough and
defaults are aligned with the
[neuromaps](https://netneurolab.github.io/neuromaps/) Python reference
implementation, discrepancies may still exist at this early stage. We
encourage users to cross-validate results against
[neuromaps](https://github.com/netneurolab/neuromaps) and to [report any
issues](https://github.com/lcbc-uio/neuromapr/issues).

## Installation

Install from the lcbc-uio
[r-universe](https://lcbc-uio.r-universe.dev/):

``` r
options(repos = c(
  lcbcuio = "https://lcbc-uio.r-universe.dev",
  CRAN = "https://cloud.r-project.org"
))

install.packages("neuromapr")
```

Or install the development version from GitHub:

``` r
# install.packages("pak")
pak::pak("lcbc-uio/neuromapr")
```

## Quick start

``` r
library(neuromapr)
```

Compare two brain maps with a spatial null model in three lines:

``` r
set.seed(42)
n <- 100
distmat <- as.matrix(dist(matrix(rnorm(n * 3), ncol = 3)))

map_a <- rnorm(n)
map_b <- 0.4 * map_a + rnorm(n, sd = 0.8)

compare_maps(
  map_a,
  map_b,
  null_method = "burt2020",
  distmat = distmat,
  n_perm = 500L,
  seed = 1,
  verbose = FALSE
)
#> 
#> ── Brain Map Comparison
#> Method: pearson
#> r = 0.5302, p = 1.4e-08
#> n = 100
#> ────────────────────────────────────────────────────────────────────────────────
#> Null model: burt2020 (500 permutations)
#> p_null = 0.002
```

The `p_null` accounts for spatial autocorrelation. The parametric `p`
does not.

## Null model methods

neuromapr provides eight methods across three families:

| Family         | Method                      | Input required               |
|----------------|-----------------------------|------------------------------|
| Distance-based | `burt2020` (variogram)      | Distance matrix              |
|                | `burt2018` (SAR model)      | Distance matrix              |
|                | `moran` (spectral)          | Distance matrix              |
| Spin-based     | `alexander_bloch`           | Sphere coordinates           |
|                | `spin_vasa` (greedy)        | Sphere coordinates           |
|                | `spin_hungarian` (optimal)  | Sphere coordinates           |
| Parcel spin    | `baum` (max overlap)        | Sphere coords + parcellation |
|                | `cornblath` (majority vote) | Sphere coords + parcellation |

All methods are accessed through
[`generate_nulls()`](https://lcbc-uio.github.io/neuromapr/reference/generate_nulls.md)
or directly via their dedicated functions (e.g.,
[`null_burt2020()`](https://lcbc-uio.github.io/neuromapr/reference/null_burt2020.md),
[`null_moran()`](https://lcbc-uio.github.io/neuromapr/reference/null_moran.md)).

## Key features

**Parcellation utilities** — aggregate vertex data into parcels, map
parcel values back to vertices, and compute parcel centroids using
average, surface, or geodesic methods.

``` r
vertex_data <- rnorm(1000)
labels <- rep(1:10, each = 100)

parcel_means <- vertices_to_parcels(vertex_data, labels)
head(parcel_means)
#>           1           2           3           4           5           6 
#>  0.11795689 -0.03426519 -0.05073563  0.04712785  0.06088535 -0.04200267
```

**Geodesic surface distance** — shortest-path distances along a
triangular mesh, for analyses where Euclidean distance through the brain
does not reflect cortical proximity.

``` r
vertices <- matrix(
  c(0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0),
  ncol = 3,
  byrow = TRUE
)
faces <- matrix(c(1, 2, 3, 2, 3, 4), ncol = 3, byrow = TRUE)

get_surface_distance(vertices, faces)
#>      [,1]     [,2]     [,3] [,4]
#> [1,]    0 1.000000 1.000000    2
#> [2,]    1 0.000000 1.414214    1
#> [3,]    1 1.414214 0.000000    1
#> [4,]    2 1.000000 1.000000    0
```

**Custom metric testing** —
[`permtest_metric()`](https://lcbc-uio.github.io/neuromapr/reference/permtest_metric.md)
runs a permutation test with any metric function, optionally using
spatial null surrogates:

``` r
result <- permtest_metric(
  map_a,
  map_b,
  metric_func = function(x, y) mean(abs(x - y)),
  n_perm = 200L,
  seed = 1
)
result$p_value
#> [1] 1
```

**Format conversions** — convert FreeSurfer `.annot` and morphometry
files to GIFTI with
[`annot_to_gifti()`](https://lcbc-uio.github.io/neuromapr/reference/annot_to_gifti.md)
and
[`fsmorph_to_gifti()`](https://lcbc-uio.github.io/neuromapr/reference/fsmorph_to_gifti.md).

## Citation

If you use neuromapr, please cite the neuromaps framework:

> Markello RD, Hansen JY, Liu Z-Q, et al. (2022). neuromaps: structural
> and functional interpretation of brain maps. *Nature Methods*, 19,
> 1472–1480. <doi:10.1038/s41592-022-01625-w>

Individual null model methods have their own citations documented in
each function’s help page.

# Package index

## Annotation Registry

Browse and download brain map annotations from the
[neuromaps](https://github.com/netneurolab/neuromaps) OSF repository.

- [`neuromaps_available()`](https://lcbc-uio.github.io/neuromapr/reference/neuromaps_available.md)
  : List available neuromaps annotations
- [`fetch_neuromaps_annotation()`](https://lcbc-uio.github.io/neuromapr/reference/fetch_neuromaps_annotation.md)
  : Download a neuromaps annotation

## Map Comparison

Statistical comparison of brain maps using spatial null models.

- [`compare_maps()`](https://lcbc-uio.github.io/neuromapr/reference/compare_maps.md)
  : Compare brain maps with spatial null model significance testing
- [`permtest_metric()`](https://lcbc-uio.github.io/neuromapr/reference/permtest_metric.md)
  : Permutation test for any metric between brain maps

## Null Model Generation

Generate spatially-constrained null distributions for brain maps.
[`generate_nulls()`](https://lcbc-uio.github.io/neuromapr/reference/generate_nulls.md)
is the main entry point; individual methods are also available directly.

- [`generate_nulls()`](https://lcbc-uio.github.io/neuromapr/reference/generate_nulls.md)
  : Generate null distributions for brain map data
- [`null_alexander_bloch()`](https://lcbc-uio.github.io/neuromapr/reference/null_alexander_bloch.md)
  : Alexander-Bloch spin test null model
- [`null_baum()`](https://lcbc-uio.github.io/neuromapr/reference/null_baum.md)
  : Baum spin test null model
- [`null_burt2018()`](https://lcbc-uio.github.io/neuromapr/reference/null_burt2018.md)
  : Burt 2018 spatial autoregressive null model
- [`null_burt2020()`](https://lcbc-uio.github.io/neuromapr/reference/null_burt2020.md)
  : Variogram-matching null model
- [`null_cornblath()`](https://lcbc-uio.github.io/neuromapr/reference/null_cornblath.md)
  : Cornblath spin test null model
- [`new_null_distribution()`](https://lcbc-uio.github.io/neuromapr/reference/null_distribution.md)
  : Create a null distribution object
- [`null_moran()`](https://lcbc-uio.github.io/neuromapr/reference/null_moran.md)
  : Moran spectral randomization null model
- [`null_spin_vasa()`](https://lcbc-uio.github.io/neuromapr/reference/null_spin_vasa.md)
  [`null_spin_hungarian()`](https://lcbc-uio.github.io/neuromapr/reference/null_spin_vasa.md)
  : Spin-test null models for brain maps

## Parcellation

Convert between vertex-level and parcel-level representations.

- [`parcellate()`](https://lcbc-uio.github.io/neuromapr/reference/parcellate.md)
  : Parcellate brain map data
- [`unparcellate()`](https://lcbc-uio.github.io/neuromapr/reference/unparcellate.md)
  : Unparcellate brain map data
- [`vertices_to_parcels()`](https://lcbc-uio.github.io/neuromapr/reference/vertices_to_parcels.md)
  : Aggregate vertex data into parcels
- [`parcels_to_vertices()`](https://lcbc-uio.github.io/neuromapr/reference/parcels_to_vertices.md)
  : Map parcel data back to vertices
- [`get_parcel_centroids()`](https://lcbc-uio.github.io/neuromapr/reference/get_parcel_centroids.md)
  : Compute parcel centroids

## Surface Geometry

Compute geodesic distances and other surface properties.

- [`make_surf_graph()`](https://lcbc-uio.github.io/neuromapr/reference/make_surf_graph.md)
  : Build an igraph from a triangular surface mesh
- [`get_surface_distance()`](https://lcbc-uio.github.io/neuromapr/reference/get_surface_distance.md)
  : Compute geodesic distances on a surface mesh
- [`vertex_areas()`](https://lcbc-uio.github.io/neuromapr/reference/vertex_areas.md)
  : Compute per-vertex surface areas

## Transforms and Resampling

Transform brain maps between coordinate spaces using Connectome
Workbench.

- [`transform_to_space()`](https://lcbc-uio.github.io/neuromapr/reference/transform_to_space.md)
  : Transform brain maps between coordinate spaces
- [`resample_images()`](https://lcbc-uio.github.io/neuromapr/reference/resample_images.md)
  : Resample brain maps for comparison
- [`check_wb_command()`](https://lcbc-uio.github.io/neuromapr/reference/check_wb_command.md)
  : Check for Connectome Workbench

## File I/O and Conversion

Read brain maps from various neuroimaging formats and convert between
them.

- [`read_brain_map_values()`](https://lcbc-uio.github.io/neuromapr/reference/read_brain_map_values.md)
  : Read vertex/voxel values from a brain map file
- [`annot_to_gifti()`](https://lcbc-uio.github.io/neuromapr/reference/annot_to_gifti.md)
  : Convert FreeSurfer annotation to GIFTI
- [`fsmorph_to_gifti()`](https://lcbc-uio.github.io/neuromapr/reference/fsmorph_to_gifti.md)
  : Convert FreeSurfer morphometry to GIFTI

# Articles

### Workflows

- [Choosing and Using Null
  Models](https://lcbc-uio.github.io/neuromapr/articles/null-models.md):
- [Working with Parcellated
  Data](https://lcbc-uio.github.io/neuromapr/articles/parcellation.md):
- [Surface
  Geometry](https://lcbc-uio.github.io/neuromapr/articles/surface-geometry.md):
